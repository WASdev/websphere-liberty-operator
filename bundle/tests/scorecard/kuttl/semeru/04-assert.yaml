# Builds off variation 03, by changing the configuration to a statefulSet: {}, and reverifies
# the Semeru deployment & service, and the application deployment (as in variation 00) 

apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-wsliberty-app-semeru-compiler-1
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: semeru-compiler
      app.kubernetes.io/instance: my-wsliberty-app-semeru-compiler-1
      app.kubernetes.io/part-of: my-wsliberty-app
  template:
    metadata:
      labels:
        app.kubernetes.io/component: semeru-compiler
        app.kubernetes.io/instance: my-wsliberty-app-semeru-compiler-1
        app.kubernetes.io/managed-by: websphere-liberty-operator
        app.kubernetes.io/name: my-wsliberty-app-semeru-compiler
        app.kubernetes.io/part-of: my-wsliberty-app
        liberty.websphere.ibm.com/semeru-compiler-generation: '1'
    spec:
      restartPolicy: Always
      serviceAccountName: my-wsliberty-app
      schedulerName: default-scheduler
      containers:
        - readinessProbe:
            tcpSocket:
              port: 38400
            initialDelaySeconds: 5
            timeoutSeconds: 1
            periodSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          terminationMessagePath: /dev/termination-log
          name: compiler
          command:
            - jitserver
          livenessProbe:
            tcpSocket:
              port: 38400
            initialDelaySeconds: 10
            timeoutSeconds: 1
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          env:
            - name: OPENJ9_JAVA_OPTIONS
              value: >-
                -XX:+JITServerLogConnections
                -XX:JITServerSSLKey=/etc/x509/certs/tls.key
                -XX:JITServerSSLCert=/etc/x509/certs/tls.crt
            - name: SA_RESOURCE_VERSION
            - name: TLS_SECRET_RESOURCE_VERSION
          securityContext:
            capabilities:
              drop:
                - ALL
            privileged: false
            runAsNonRoot: true
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
          ports:
            - containerPort: 38400
              protocol: TCP
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: certs
              readOnly: true
              mountPath: /etc/x509/certs
          terminationMessagePolicy: File
          image: 'icr.io/appcafe/websphere-liberty:kernel-java17-openj9-ubi'
      serviceAccount: my-wsliberty-app
      volumes:
        - name: certs
          secret:
            secretName: my-wsliberty-app-semeru-compiler-1-tls-cm
            defaultMode: 420
      dnsPolicy: ClusterFirst
  strategy:
    type: Recreate
---
kind: Service
apiVersion: v1
metadata:
  name: my-wsliberty-app-semeru-compiler-1
  labels:
    app.kubernetes.io/component: semeru-compiler
    app.kubernetes.io/instance: my-wsliberty-app-semeru-compiler-1
    app.kubernetes.io/managed-by: websphere-liberty-operator
    app.kubernetes.io/name: my-wsliberty-app-semeru-compiler
    app.kubernetes.io/part-of: my-wsliberty-app
    liberty.websphere.ibm.com/semeru-compiler-generation: '1'
spec:
  ports:
    - protocol: TCP
      port: 38400
      targetPort: 38400
  sessionAffinity: ClientIP
  selector:
    app.kubernetes.io/component: semeru-compiler
    app.kubernetes.io/instance: my-wsliberty-app-semeru-compiler-1
    app.kubernetes.io/part-of: my-wsliberty-app
---
kind: StatefulSet
apiVersion: apps/v1
metadata:
  name: my-wsliberty-app
spec:
  template:
    spec:
      containers:
        - resources: {}
          image: 'icr.io/appcafe/websphere-liberty:kernel-java17-openj9-ubi'
      serviceAccount: my-wsliberty-app
status:
  observedGeneration: 1
  replicas: 1
  updatedReplicas: 1
  readyReplicas: 1
  availableReplicas: 1